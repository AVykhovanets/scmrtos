<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4: http://docutils.sourceforge.net/" />
<title>scmRTOS v3 AVR/GCC Release Notes</title>
<meta name="author" content="Harry E.Zhurov, OLeksandr O.Redchuk" />
<meta name="date" content="$Date $" />
<style type="text/css">


body {
	color: Black;
/*	background-color: #E6EEFC; */
	background-color: #F1F6FE;
	font-family: "Trebuchet MS", Garamond, Tahoma, "Courier New", Courier, sans-serif;
	font-size: medium;
}

pre {
	background-color: #D4D8DE;
}

li {
	font-family: sans-serif;
	font-size: small;
	font-weight: normal;
	color: Black;
}



tr {
	text-align: left;
}


h1.title {
   text-align: center;
   background-color: #123676;
	color: #D2C01A;
	font-family: Tahoma, sans-serif;
	font-weight: bold;
	font-size: 24px;
  }


h1 {
	background-color: #AEC8F6;
	border: none;
	font-family: Verdana, Tahoma, sans-serif;
	font-weight: bold;
	font-size: 20px;
}
	
	
h2 {
	font-family: Verdana, Tahoma, sans-serif;
	font-size: 16px;
}

a {
	color: #232791;
}

A:visited {
	color: #DBA083; /* #4169E1;	*/
}

p {
	font-family: "Trebuchet MS", Garamond, System, Verdana, Tahoma, sans-serif;
	font-size: medium;
	font-weight: normal;
	color: Black;
}

.contents {
	font-family: Arial, sans-serif;
	font-weight: bolder;
	font-size: medium;
}


</style>
</head>
<body>
<div class="document" id="scmrtos-v3-avr-gcc-release-notes">
<h1 class="title">scmRTOS v3 AVR/GCC Release Notes</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Harry E.Zhurov, Oleksandr O.Redchuk</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>$Date $</td></tr>
<tr><th class="docinfo-name">Revision:</th>
<td>$Rev $</td></tr>
<tr class="field"><th class="docinfo-name">Info:</th><td class="field-body">See main scmRTOS User's Manual for details</td>
</tr>
</tbody>
</table>


<hr class="docutils" />
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">contents</a></p>
<ul class="simple">
<li><a class="reference" href="#preamble" id="id7" name="id7">Preamble</a></li>
<li><a class="reference" href="#general-description" id="id8" name="id8">General Description</a></li>
<li><a class="reference" href="#sample-structure" id="id9" name="id9">Sample Structure</a></li>
<li><a class="reference" href="#usage" id="id10" name="id10">Usage</a><ul>
<li><a class="reference" href="#working-with-repository" id="id11" name="id11">Working with Repository</a></li>
<li><a class="reference" href="#working-with-release" id="id12" name="id12">Working with Release</a></li>
<li><a class="reference" href="#standalone-rtos-sources" id="id13" name="id13">Standalone RTOS sources</a></li>
</ul>
</li>
<li><a class="reference" href="#building" id="id14" name="id14">Building</a>
<ul>
<li><a class="reference" href="#make" id="id15" name="id15">Using make</a></li>
<li><a class="reference" href="#makefile-customisation" id="id16" name="id16">makefile customisation</a></li>
<!-- <li><a class="reference" href="#other-build" id="id17" name="id17">Other build system</a></li> -->
</ul>
</li>
</ul>
</div>


<hr class="docutils" />
<div class="section">
<h1><a class="toc-backref" href="#id7" id="preamble" name="preamble">Preamble</a></h1>
<p>Release includes a sample set that contains three samples and RTOS sources.
The purpose of the sample set is to show use examples and primary RTOS
functionality and features.</p>
</div>


<hr class="docutils" />
<div class="section">
<h1><a class="toc-backref" href="#id8" id="general-description" name="general-description">General Description</a></h1>
<p>RTOS consists of three parts:</p>
<ul class="simple">
<li>Common part;</li>
<li>Target-dependent part;</li>
<li>Project-dependent part.</li>
</ul>
<p>Common part contains main RTOS definitions and declarations such as RTOS kernel,
interprocess communication services and little support library. All Common sources
stand at <tt class="docutils literal"><span class="pre">Common</span></tt> subfolder (see below).</p>
<p>Target-dependent part describes target processor and toolkit features of the RTOS:</p>
<ul class="simple">
<li>Target-level configuration macros;</li>
<li>Critical section definition;</li>
<li>Some performance-critical functions;</li>
<li>Interrupt and interrupt service routines support;</li>
<li>Target processor specific process's constructor;</li>
<li>Idle process declaration.</li>
</ul>
<p>Project-dependent part includes two header files:</p>
<ul class="simple">
<li>scmRTOS_CONFIG.h;</li>
<li>scmRTOS_TARGET_CFG.h.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">scmRTOS_CONFIG.h</span></tt> describes project-level RTOS configuration macros.</p>
<p><tt class="docutils literal"><span class="pre">scmRTOS_TARGET_CFG.h</span></tt> contains project-level tuning code, in particular
System Timer and context switch software interrupt stuff. Default, WatchDog Timer
is used as System Timer, and Analog Comparator Interrupt as Software Context
Switch Interrupt. The user can change these setting to more project-suitable if
need.</p>
</div>


<hr class="docutils" />
<div class="section">
<h1><a class="toc-backref" href="#id9" id="sample-structure" name="sample-structure">Sample Structure</a></h1>
<p>The sample consists of three parts:</p>
<ul class="simple">
<li>EventFlag.</li>
<li>message.</li>
<li>channel.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">EventFlag</span></tt> sample brings test on speed. <tt class="docutils literal"><span class="pre">OS::TEventFlag</span></tt>  is the simplest and
fastest   service   of   the   RTOS.   In  this  example  program  control  flow
transferred  from   timer   interrupt   service   routine   (ISR)   to   waiting
process.  Dedicated  processor's pin is set  to '1' before signalling of the
<tt class="docutils literal"><span class="pre">EventFlag</span></tt>  and set to '0' inside  waiting  process.  So, positive pulse width on
this pin corresponds with program control flow transfer time. Another five pins are set to '1' or '0' on various events, detailed description and oscillograms see in <a class="reference" href="1-EventFlag/doc/1-EventFlag-scope.html">./1-EventFlag/doc/1-EventFlag-scope.html</a></p>
<p><tt class="docutils literal"><span class="pre">OS::message</span></tt> sample demonstrates ability to send arbitrary information from ISRs
and  processes  to  processes.  In the example one process waits the message and
timer  ISR and another process send the message. Message content is different in
each case, so, process-receiver can distinguish the source of the message.</p>
<p>Sample  with  <tt class="docutils literal"><span class="pre">OS::channel</span></tt>  shows  a  message  queue. Since the message can have
arbitrary type, current example uses pointers to class types. In the example two
more  priority  processes  &quot;delegate&quot;  some  actions to the third (low-priority)
process. See scmRTOS documentation  Appendix section for more details about this
mechanism.</p>
<p>Contents  of  all parts is the same: test project and RTOS sources. Each located
in its own folder.</p>
<p>Structure of test project folder (folders are in brackets '[]'):</p>
<pre class="literal-block">
[makefiles]       - common project-independent makefiles for avr-gcc and avreal
[src]             - test project sources
[exe]             - executable product[s]
[lst]             - listings and other temporary text files
[obj]             - objects and other intermediate files
makefile	  - project make script
</pre>
<p>folders [exe], [lst], [obj] are not saved in repository and created during compilation process</p>
<p>Structure of the RTOS folder:</p>
<pre class="literal-block">
scmRTOS
  Common           - common RTOS sources
  AVR              - portable part
</pre>
</div>


<hr class="docutils" />
<div class="section">
<h1><a class="toc-backref" href="#id10" id="usage" name="usage">Usage</a></h1>
<p>AVR/GCC port intended to be used with avr-gcc v3.4.x and later versions. Work with versions before v3.4 not tested, versions before 3.0 are not supported.</p>
<p>There are two variants of usage. The first variant is checking out sample set from the
<a class="reference" href="https://scmrtos.svn.sourceforge.net/svnroot/scmrtos">SourceForge repository</a>. The second one is downloading the release archive and using it locally.</p>
<div class="section">
<h2><a class="toc-backref" href="#id11" id="working-with-repository" name="working-with-repository">Working with Repository</a></h2>
<p>Initially, after checkout from repository the folders</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">scmRTOS/Common</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">scmRTOS/AVR</span></tt></div>
</div>
<p>are  empty. User has to switch these folders manually to appropriate repository
folders:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">scmRTOS/Common</span> <span class="pre">to</span> <span class="pre">$REP$/Common</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">scmRTOS/AVR</span>&nbsp;&nbsp;&nbsp; <span class="pre">to</span> <span class="pre">$REP$/Ports/AVR/GCC</span></tt></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">$REP$</span></tt> is proper branch of the repository.</p>
<p>After this working copy is ready to build.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id12" id="working-with-release" name="working-with-release">Working with Release</a></h2>
<p>In  this  case  no  extra  actions  required. User can build the samples at this
point.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id13" id="standalone-rtos-sources" name="standalone-rtos-sources">Standalone RTOS sources</a></h2>
<p>There is one more way to usage RTOS (RTOS only, not the whole release). To do this
the user has to create local folders for RTOS sources - for Common part and for Port
part as well. For example, create at user's project folder subfolder <tt class="docutils literal"><span class="pre">scmRTOS</span></tt> (or
with any other suitable name); inside this subfolder create subfolders for Common
and Port sources; set to this subfolders <tt class="docutils literal"><span class="pre">svn:externals</span></tt> <a class="footnote-reference" href="#id4" id="id1" name="id1">[1]</a> properties that will link
these subfolders to the appropriate folders in <a class="reference" href="https://scmrtos.svn.sourceforge.net/svnroot/scmrtos">external (SourceForge) repository</a>.</p>
<p>In this way, user gets the ability to synchronize its project RTOS sources with <a class="reference" href="https://scmrtos.svn.sourceforge.net/svnroot/scmrtos">main
RTOS repository</a>.</p>
</div>
</div>


<hr class="docutils" />
<div class="section">
<h1><a class="toc-backref" href="#id14" id="building" name="building">Building</a></h1>

<div class="section">
<h2><a class="toc-backref" href="#id15" id="make" name="make">Using make</a></h2>
<p>Just run make in the sample root folder (folder where makefile located)
<pre class="literal-block">
$PROMPT$&gt;make
</pre>
make will build the project
<pre class="literal-block">
$PROMPT$&gt;make run
</pre>
make will rebuild project if needed and download project into target board using avreal (use <tt class="docutils literal"><span class="pre">make fuses</span></tt> at first time programming).</p>
</div>

<div class="section">
<h2><a class="toc-backref" href="#id16" id="makefile-customisation" name="makefile-customisation">makefile customisation</a></h2>
</p>You can change some variables in project makefile:
<pre class="literal-block">AVRGCC=c:/WinAVR-20071221</pre>
This variable point to toolkit root folder and can be changed for compiling by another version of avr-gcc.
<pre class="literal-block">MAKE_SMALLEST_HEX = Y</div>
'Y' - on compiler and linker switches for relaxation and unused code/data objects removing.
This option can be used only with avr-gcc v4.0 and later.
<pre class="literal-block">TRG = message</pre>
Target name (base name for .elf, .hex and .eep files).
<pre class="literal-block">MCU := atmega168</pre>
Processor model.
<pre class="literal-block">TRGPGMEXT = hex eep</pre>
Space-separated list of target files extensions. `hex' and `eep' are allowed values.
Place `eep' here if .eeprom section actually used and $(TRG).eep file needed.
Variable used for generating target names in makefiles/avr-gcc.mak and `run' target avreal command line arguments in makefiles/avreal.mak.
<pre class="literal-block">FUSES = bodlevel=5,cksel=2,ckdiv8=off,sut=0</pre>
Fuse list for avreal -f swicth. No spaces allowed inside value string.
<pre class="literal-block">AVREAL_OPT= -n</pre>
Additional avreal options - for example, erase counter or chip lock switch.
<pre class="literal-block">F_CPU=8000000</pre>
Processor clock frequency in Hz.
Used for C-compiler F_CPU define and avreal -o switch.
</p>
<p>Another variables are clear for gcc users.
</div>

<!--
<div class="section">
<h2><a class="toc-backref" href="#id17" id="other-build" name="other-build">Other build system</a></h2>

<p>If  user want to use his own build system <a class="footnote-reference" href="#id6" id="id3" name="id3">[2]</a> he has to specify the following
command-line options for various tools:</p>

<h2>C-compiler:</h2>
<pre class="literal-block">
-mmcu=atmega168
-Os
-I./src -I../scmRTOS/AVR -I../scmRTOS/Common
-ffunction-sections -fdata-sections # for minimal HEX size, only for avr-gcc v4.0 and higher
</pre>

<h2>Assembler:</h2>
<pre class="literal-block">
-mmcu=atmega168
-I./src -I../scmRTOS/AVR -I../scmRTOS/Common
</pre>

<h2>Linker:</h2>
<pre class="literal-block">
-mmcu=atmega168
--gc-sections # for minimal HEX size, only for avr-gcc v4.0 and higher
--relax
</pre>

<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">where $TOOLKIT_PATH$ - path to folder with toolkit installed.</p>
</div>
-->

<hr class="docutils" />
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1" name="id4">[1]</a></td><td>For more details about <tt class="docutils literal"><span class="pre">svn:externals</span></tt> see <a class="reference" href="http://subversion.tigris.org">Subversion</a> documentation.</td></tr>
</tbody>
</table>

<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3" name="id6">[2]</a></td><td>For example, step-up to scons or step-down to simple bat file.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</body>
</html>
